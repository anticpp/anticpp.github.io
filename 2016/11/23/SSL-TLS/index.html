<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ssl/tls | supergui</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="最近在折腾Microservice的gRPC鉴权问题，顺带梳理了下ssl/tls的原理。以前没有特别深究过里面的问题，最近大概都算理清楚了，这里Mark也下。
1. ssl/tlsssl/tls是一套基于非对称加密的安全协议，实际上ssl和tls是两个版本，大多数情况下这两个名词一起被提到，可以理解为tls是ssl的升级版本。
2. https其实https是泛指http over secure，">
<meta property="og:type" content="article">
<meta property="og:title" content="ssl/tls">
<meta property="og:url" content="http://anticpp.github.io/2016/11/23/ssl-tls/index.html">
<meta property="og:site_name" content="supergui">
<meta property="og:description" content="最近在折腾Microservice的gRPC鉴权问题，顺带梳理了下ssl/tls的原理。以前没有特别深究过里面的问题，最近大概都算理清楚了，这里Mark也下。
1. ssl/tlsssl/tls是一套基于非对称加密的安全协议，实际上ssl和tls是两个版本，大多数情况下这两个名词一起被提到，可以理解为tls是ssl的升级版本。
2. https其实https是泛指http over secure，">
<meta property="og:image" content="http://anticpp.github.io/images/tls_certification.png">
<meta property="og:image" content="http://anticpp.github.io/images/https_error.png">
<meta property="og:updated_time" content="2021-03-04T07:05:15.940Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ssl/tls">
<meta name="twitter:description" content="最近在折腾Microservice的gRPC鉴权问题，顺带梳理了下ssl/tls的原理。以前没有特别深究过里面的问题，最近大概都算理清楚了，这里Mark也下。
1. ssl/tlsssl/tls是一套基于非对称加密的安全协议，实际上ssl和tls是两个版本，大多数情况下这两个名词一起被提到，可以理解为tls是ssl的升级版本。
2. https其实https是泛指http over secure，">
<meta name="twitter:image" content="http://anticpp.github.io/images/tls_certification.png">
  
    <link rel="alternate" href="/atom.xml" title="supergui" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">supergui</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">迁于乔木，出自幽谷</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Buscar"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://anticpp.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-ssl-tls" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/23/ssl-tls/" class="article-date">
  <time datetime="2016-11-23T06:12:57.000Z" itemprop="datePublished">2016-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ssl/tls
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在折腾Microservice的gRPC鉴权问题，顺带梳理了下ssl/tls的原理。<br>以前没有特别深究过里面的问题，最近大概都算理清楚了，这里Mark也下。</p>
<h1 id="1-ssl-tls"><a href="#1-ssl-tls" class="headerlink" title="1. ssl/tls"></a>1. ssl/tls</h1><p>ssl/tls是一套基于非对称加密的安全协议，实际上ssl和tls是两个版本，大多数情况下这两个名词一起被提到，可以理解为tls是ssl的升级版本。</p>
<h1 id="2-https"><a href="#2-https" class="headerlink" title="2. https"></a>2. https</h1><p>其实https是泛指http over secure，是在http协议之上增加的安全协议。当然，也有人会把它理解为http over ssl或者http over tls。<br>一般我们提到https都会默认提到ssl/tls，是因为ssl/tls在当前是最成熟的应用到https上。</p>
<h1 id="3-ssl-tls握手"><a href="#3-ssl-tls握手" class="headerlink" title="3. ssl/tls握手"></a>3. ssl/tls握手</h1><p>实际上https在安全机制上是做了两个事情，我们常常也会忽略。</p>
<ul>
<li>加密传输</li>
<li>证书校验</li>
</ul>
<p>握手的过程大概如下</p>
<ul>
<li>Client端发送ClientHello给Server端。包含协议版本、一个随机数(Random1)、支持的加密算法、压缩算法等。</li>
<li>Server端发送ServerHello给Client端。包含协议版本的确认、一个随机数(Random2)、确认的加密算法、压缩算法等。</li>
<li>Server端发送Certificate(证书)给Client端。</li>
<li>Server端发送ServerHelloDone给Client端。</li>
<li>Client端发送ClientKeyExchange给Server端。包含一个随机数PreMasterSecret，并且PreMasterSecret要用证书里面的公钥进行加密。</li>
<li><p>Server端用自己的私钥把PreMasterSecret解开。Client和Server都用Random1、Random2、PreMasterSecret算出来MasterSecret，这个MasterSecret就是双方约定的加密传输的对称秘钥，并且使用之前协商的加密算法，进行后续的数据交互。</p>
<p>  注意：</p>
<ol>
<li>Server端所持有的私钥和公钥（在Certificate里面），并没有参与Certificate校验的过程，只是用来做最后一个随机数PreMasterSecret的加密保障。</li>
<li>这个过程并没有描述Certificate在Client端是怎么验证的，也就是Client根据什么确认Server的签名信息。</li>
</ol>
</li>
</ul>
<h1 id="4-ssl-tls加密传输"><a href="#4-ssl-tls加密传输" class="headerlink" title="4. ssl/tls加密传输"></a>4. ssl/tls加密传输</h1><p>加密传输是https的最重要特性，保证了所有网络上的数据不会被明文探测。整个握手过程实际上是明文的，生成MasterSecret的前面两个随机数也是明文。实际最终保证安全性的关键在于，PreMasterSecret这个随机数的安全性。而这个随机数的安全性是建立在非对称加密的安全性上面。</p>
<h1 id="5-ssl-tls证书校验"><a href="#5-ssl-tls证书校验" class="headerlink" title="5. ssl/tls证书校验"></a>5. ssl/tls证书校验</h1><h2 id="5-1-基本原理"><a href="#5-1-基本原理" class="headerlink" title="5.1 基本原理"></a>5.1 基本原理</h2><p>证书签名的基本原理很简单，一般是利用非对称加密算法。非对秘钥一般成对出现（最常用的RSA），一个公钥，一个私钥。<br>公钥加密的信息，只有私钥能解开。同理，私钥加密的信息，只有公钥能解开。<br>例如：我用私钥加密一段内容，同时告诉对方我的公钥，对方如果可以用我的公钥解开我的内容，就可以证明这段信息是我的。这里面，被加密的内容就可以作为签名信息。</p>
<h2 id="5-2-关于CA-证书校验"><a href="#5-2-关于CA-证书校验" class="headerlink" title="5.2 关于CA/证书校验"></a>5.2 关于CA/证书校验</h2><p>ssl/tls的握手过程，往往容易忽略证书校验的过程，这个发生在握手的第3步，Server端发送证书给客户单之后，客户端是怎么验证证书的合法性呢？<br>握手的过程很简单，Server端的一组非对称秘钥，并没有参与到任何证书校验的环节，只是用来做了最后一个随机数PreMasterSecret的安全保障。</p>
<p>实际上我们Server的一对秘钥，并不是用来做证书校验，证书校验是通过另外一组非对称秘钥来保证。<br>这里就要提到<strong><em><a href="https://en.wikipedia.org/wiki/Certificate_authority" target="_blank" rel="external">CA(Certificate Authority)</a></em></strong>，CA是一个权威机构，主要负责证书的签名、发放、校验等职责。<br>主要逻辑参考这个图</p>
<p><img src="/images/tls_certification.png" alt="certification_flow"></p>
<ol>
<li>CA本身有自己的一套根密钥(cakey.pem)、根证书(cacert.pem一般包含了证书信息、对应的公钥信息等)</li>
<li>Server生成自己的密钥(server_key.pem)和证书签名请求CSR(server_csr.pem)</li>
<li><p>Server拿server_csr.pem到CA进行签名，得到server_crt.pem，即最终的证书。CA签名的过程，可以简单理解为用cakey.pem对server_csr.pem增加一段加密的签名信息。这段签名信息，只有CA的公钥（公钥信息在cacert.pem可以得到）可以解开。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F(cakey.pem, server_csr.pem) = server_crt.pem</span><br></pre></td></tr></table></figure>
</li>
<li><p>Client端（一般是浏览器）会内置了CA的根证书(cacert.pem)。在ssl/tls握手的第3步，Client拿到Server的Certificate（这个其实就是server_crt.pem），就可以根据CA的根证书对Certificate进行验证。</p>
</li>
</ol>
<p>所以，最终证书的安全性建立在Client端的CA根证书的安全性。</p>
<pre><code>Note: 怎么保证Client端CA证书的安全性？
</code></pre><h2 id="5-3-为什么要给钱"><a href="#5-3-为什么要给钱" class="headerlink" title="5.3 为什么要给钱"></a>5.3 为什么要给钱</h2><p>正常的网站，为了做网站的证书签名，都需要找到权威的CA机构进行证书签名，而CA对这块都是要付费的。<br>那问题是，我们为什么非得找这些CA付费，自己随便搞一个假的CA进行对自己的证书进行签名不就行了吗。<br>其实也有人这样干，大家可以参考万恶的<a href="http://www.12306.cn" target="_blank" rel="external">http://12306.cn</a>。对，就是那个全世界最大的电商网站。<br>例如用Chrome访问都会提示证书不安全，因为他们并没有找权威CA进行证书签名。<br><img src="/images/https_error.png" alt="https_error"><br>CA的权威性，是建立在行业标准之上的存在，所以对浏览器厂商也会遵循这些行业标准。也就是，这些浏览器都会内置权威的CA的根证书。为了让浏览器能显示你是认证的网站 ，必须找权威的CA机构，给钱、签名。</p>
<h1 id="6-Openssl自建CA、Server数字证书"><a href="#6-Openssl自建CA、Server数字证书" class="headerlink" title="6. Openssl自建CA、Server数字证书"></a>6. Openssl自建CA、Server数字证书</h1><p>恩，为什么要自建CA呢。<br>上面说了，ssl/tls实际上是做了两个事情，加密传输和证书验证。<br>这两个事情，其实不太相关。<br>证书验证，大部分场景是在网站浏览器端，所以网站必须给权威的CA机构付费。<br>但是，如非浏览器应用，我们只是想利用xls/tls加密传输。<br>我们就完全有理由自己搞私有的CA，自己给自己发证书了。</p>
<p>Openssl工具提供了一整套完整的命令行工具，大概流程如下<br>主要做几件事情</p>
<ol>
<li>配置自己的CA</li>
<li>生成Server的密钥，CSR</li>
<li>用CSR到CA签名，生成CRT，也就是证书</li>
</ol>
<pre><code>CSR: Certificate Signing Request，证书签名请求
CRT: Certificate，证书
</code></pre><h2 id="6-1-配置CA"><a href="#6-1-配置CA" class="headerlink" title="6.1 配置CA"></a>6.1 配置CA</h2><p>如果安装了Openssl，默认的路径在/etc/pki/。<br>配置文件路径在tls/openssl.cnf，基本的配置可以不用改。<br>可以简单关注一下policy_match相关的配置，这里配置了对不同证书信息是否进行校验。</p>
<ul>
<li><p>进入CA目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd CA/</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建两个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch index.txt serial</span><br><span class="line">echo 01 &gt; serial</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建根密钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out private/cakey.pem 2048</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建根证书<br>需要用到密钥 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -key private/cakey.pem -out cacert.pem</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="6-2-配置Server"><a href="#6-2-配置Server" class="headerlink" title="6.2 配置Server"></a>6.2 配置Server</h2><ul>
<li><p>生成Server密钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out server_key.pem 2048</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成Server CSR<br>需要用到密钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key server_key.pem -out server_csr.pem</span><br><span class="line">...</span><br><span class="line">Country Name (2 letter code) [AU]:CN</span><br><span class="line">State or Province Name (full name) [Some-State]:GD</span><br><span class="line">Locality Name (eg, city) []:SZ</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:COMPANY</span><br><span class="line">Organizational Unit Name (eg, section) []:IT_SECTION</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:your.domain.com</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="6-3-证书签名"><a href="#6-3-证书签名" class="headerlink" title="6.3 证书签名"></a>6.3 证书签名</h2><p>把上一步的server_csr.pem发给CA机器，在CA机器上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -in server_csr.pem -out server_crt.pem</span><br></pre></td></tr></table></figure></p>
<h2 id="6-4-完成"><a href="#6-4-完成" class="headerlink" title="6.4 完成"></a>6.4 完成</h2><p>Server端持有: 密钥server_key.pem、证书server_crt.pem<br>Client端持有: CA的根证书cacert.pem</p>
<p>双方即可进行ssl/tls握手通信</p>
<h1 id="7-ssl-tls双向校验"><a href="#7-ssl-tls双向校验" class="headerlink" title="7. ssl/tls双向校验"></a>7. ssl/tls双向校验</h1><p>因为在做gRPC鉴权的时候，我们需要的Server端对Client进行身份鉴权，于是发现ssl/tls是支持双向鉴权。<br>简单来说就是，除了Client端对Server端进行证书鉴权，Server端也会要求对Client进行证书鉴权。</p>
<p>握手过程如下，加粗的步骤是新增的。</p>
<ul>
<li>Client端发送ClientHello给Server端。包含协议版本、一个随机数(Random1)、支持的加密算法、压缩算法等。</li>
<li>Server端发送ServerHello给Client端。包含协议版本的确认、一个随机数(Random2)、确认的加密算法、压缩算法等。</li>
<li>Server端发送Certificate(证书)给Client端。</li>
<li><strong><strong>Server端发送Certificate Request给Client端，要求Client端提供证书。</strong></strong></li>
<li>Server端发送ServerHelloDone给Client端。</li>
<li><strong><strong>Client端发送Certificate给Server端。</strong></strong></li>
<li>Client端发送ClientKeyExchange给Server端。包含随机数PreMasterSecret，并且PreMasterSecret要用证书的公钥进行加密。</li>
<li>Client和Server端用Random1、Random2、PreMasterSecret算出来MasterSecret，这个MasterSecret就是双方约定的加密传输的对称秘钥，并且使用之前协商的加密算法，进行后续的数据交互。</li>
</ul>
<p>服务器拿到Client端的Certificate，进行类似Client端对Server端的Certificate校验过程，这样就实现了双向校验。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://anticpp.github.io/2016/11/23/ssl-tls/" data-id="ckm1gbme6000g25p3dkizfzio" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/security/">security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssl-tls/">ssl/tls</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/11/24/openssl-tools/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Nuevo</strong>
      <div class="article-nav-title">
        
          Openssl tools
        
      </div>
    </a>
  
  
    <a href="/2016/11/14/udp-size/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Viejo</strong>
      <div class="article-nav-title">UDP package size</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IP/">IP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dht/">dht</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/media/">media</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/meeting/">meeting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mq/">mq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/p2p/">p2p</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programing-lanuage/">programing lanuage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl-tls/">ssl/tls</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nube de Tags</h3>
    <div class="widget tagcloud">
      <a href="/tags/IP/" style="font-size: 10px;">IP</a> <a href="/tags/dht/" style="font-size: 10px;">dht</a> <a href="/tags/go/" style="font-size: 20px;">go</a> <a href="/tags/media/" style="font-size: 10px;">media</a> <a href="/tags/meeting/" style="font-size: 10px;">meeting</a> <a href="/tags/mq/" style="font-size: 10px;">mq</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/p2p/" style="font-size: 10px;">p2p</a> <a href="/tags/programing-lanuage/" style="font-size: 15px;">programing lanuage</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/ssl-tls/" style="font-size: 10px;">ssl/tls</a> <a href="/tags/tools/" style="font-size: 20px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archivos</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Posts recientes</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/04/message-queue/">Message queue</a>
          </li>
        
          <li>
            <a href="/2018/05/11/gopher-2018/">Gopher 2018 shanghai memo</a>
          </li>
        
          <li>
            <a href="/2018/05/05/cpp-virtual-vs-go-interface/">Go interface internal</a>
          </li>
        
          <li>
            <a href="/2018/05/03/private-addr/">IPv4 private address</a>
          </li>
        
          <li>
            <a href="/2018/04/17/dht/">DHT</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 supergui@live.cn<br>
      Construido por <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>




  </div>
</body>
</html>